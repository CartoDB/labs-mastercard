<!DOCTYPE html>
<html>
  <head>
    <title>Mastercard</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="https://cartodb.com/favicon.ico" />
    <link href='https://fonts.googleapis.com/css?family=Istok+Web' rel='stylesheet' type='text/css'>
    <link href='reset.css' rel='stylesheet' type='text/css'>
    <link href='app.css' rel='stylesheet' type='text/css'>
    <script src="Chart.min.js"></script>
    <link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/themes/css/cartodb.css" />
    <style>
      #form{ position: absolute;bottom: 32px; right: 80px;z-index: 100;}
      .styled-select {
         height: 29px;
         overflow: hidden;
         background-color: transparent;
         float: left;
      }

      .styled-select.month {
         width: 80px;
         text-align: left;
       }
      .styled-select.day.january{
         display: none;
       }
      .styled-select.day {
         width: 30px;
       }
      .styled-select.hour {
         width: 50px;
       }
      .styled-select select {
         background: transparent;
         border: none;
         font-size: 14px;
         height: 29px;
         padding: 5px; /* If you add too much padding here, the options won't show in IE */
         width: 100px;
      }
       .styled-select select    { color: #000; }
    </style>
    <script type="cartocss/html" id="choro_template">
#us_zip_codes_2013_mc{
  polygon-fill: transparent;
  polygon-opacity: 0.5;
  line-color: #5199db;
  line-width: 1;
  line-opacity: 0.3;
}
#us_zip_codes_2013_mc [ band <= 5] {
   polygon-fill: #a50f15;
   polygon-opacity: 1;
}
#us_zip_codes_2013_mc [ band <= 4] {
   polygon-fill: #de2d26;
}
#us_zip_codes_2013_mc [ band <= 3] {
   polygon-fill: #fb6a4a;
}
#us_zip_codes_2013_mc [ band <= 2] {
   polygon-fill: #fcae91;
}
#us_zip_codes_2013_mc [ band <= 1] {
   polygon-fill: #fee5d9;
}
    </script>
  </head>
  <body>
    <ul class="lst-menu">
      <li><a href="index.html">The international DMA view.</a></li>
      <li class="active"><a href="boston.html">Boston during a snowstorm</a></li>
    </ul>
    <div class="title-container">
      <div class="title">
        <div id="back" class="hide"></div>
        <div class="title-txt">
          <h1>Local Commerce / Global Scale
            <a id="openProject" href="#openProjectModal"><img src="img/icon-info.png" alt="info about this project" /></a>
          </h1>
          <h2>A partnership between MasterCard and CartoDB</h2>
        </div>
      </div>
      <div class="title-decoration">
        <div class="title-decoration-brand">
          <img src="img/brands.png" alt="mastercard and cartodb" />
        </div>

      </div>
    </div>
    

    <div id="form">
      <div class="styled-select date">
        <select>
          <option SELECTED value="1">Monday January 19 15:00</option>
          <option value="2">Tuesday January 20 15:00</option>
          <option value="3">Friday January 23 15:00</option>
          <option value="4">Monday January 26 15:00</option>
          <option value="5">Tuesday January 27 15:00</option>
          <option value="6">Friday January 30 15:00</option>
        </select>
      </div>
    </div>

    <div id="splash_screen" class="splash">
      <a id="openBoston" href="#openBostonModal">What am I looking at right now?</a>
    </div>
    <div id="openProjectModal" class="modalDialog">
      <a href="#close" title="Close" class="close">X</a>
      <div>
        <h1>CartoDB and MasterCard Combine to Leverage the Power of Location Intelligence</h1>
        <h2>Using the power of CartoDBâ€™s technology, MasterCard visualizes local trends and insights from its global database. These data visualizations can be utilized to understand surge events such as extreme weather impacts, help predict transit and traffic impacts based on spend patterns, and garner insights about domestic and international tourism. With these insights, city governments can operate their cities more efficiently, companies can better understand their customers, and consumers can enjoy more tailored shopping experiences.</h2>
      </div>
    </div>
    <div id="openBostonModal" class="modalDialog">
      <a href="#close" title="Close" class="close">X</a>
      <div>
        <h1>Boston: A Snowy Economy</h1>
        <h2>Browse using the date selector in the lower right and see the amount of financial transactions in Boston-area towns change as a major snowstorm passes through the region around January 27.</h2>
      </div>
    </div>
    
    
    <div id="map"></div>
    <!-- include cartodb.js library -->
    <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.12/cartodb.uncompressed.js"></script>

    <script>
      function main() {
        var centerD = [42.338, -71.153];
        var zoomD = 10;

        var map = L.map('map', { 
          center: centerD,
          zoom: zoomD
        })

        function makeSql(m,d,h){
          console.log("SELECT the_geom, the_geom_webmercator, (SELECT transband FROM ma_dma WHERE month = "+m+" and day = "+d+" and hourband = "+h+" AND merchzip = u.zcta5ce10) as band FROM us_zip_codes_2013_mc u")
          return "SELECT the_geom, the_geom_webmercator, (SELECT transband FROM ma_dma WHERE month = "+m+" and day = "+d+" and hourband = "+h+" AND merchzip = u.zcta5ce10) as band FROM us_zip_codes_2013_mc u";
        }
        L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_nolabels/{z}/{x}/{y}.png',{
          attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
        }).addTo(map);

        var m = 1, d = 19, h = 15;
        var date;
        // add cartodb layer with one sublayer
        cartodb.createLayer(map, {
          user_name: 'ashmurali',
          type: 'cartodb',
          sublayers: [{
             sql: makeSql(m,d,h),
             cartocss: $('#choro_template').html()
          }]
        })
        .addTo(map)
        .done(function(layer) {

          $('.date').on('change', function(e){
            date = parseInt($('.date select').val());
            console.log(date);
            if (date == 1) {
              m = 1, d = 19, h = 15;
              console.log(m,d,h);
            }
            else if (date == 2) {
              m = 1, d = 20, h = 15;
              console.log(m,d,h);
            }
            else if (date == 3) {
              m = 1, d = 23, h = 15;
              console.log(m,d,h);
            }
            else if (date == 4) {
              m = 1, d = 26, h = 15;
              console.log(m,d,h);
            }
            else if (date == 5) {
              m = 1,d = 27, h = 15;
              console.log(m,d,h);
            }
            else if (date == 6) {
              m = 1, d = 30, h = 15;
              console.log(m,d,h);
            }
            layer.getSubLayer(0).setSQL(makeSql(m,d,h));
          });

        });
      }

      window.onload = main;
    </script>
  </body>
</html>